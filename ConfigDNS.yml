---
- name: Configure DNS Server on Windows
  hosts: Server
  gather_facts: no
  vars:
    # ðŸŒ Editable Variables (Change here only)
    forward_zone: "local"
    reverse_network: "1.168.192"     # For 192.168.101.0/24 â†’ reverse = 101.168.192
    dns_forwarders:
      - "8.8.8.8"
      - "1.1.1.1"
    dns_server_name: "DNS-Server-AWX"
    dns_server_ip: "192.168.1.4"
    web_server_ip: "192.168.1.3"
    host_name: "webserver"

  tasks:

    # 1ï¸âƒ£ Install DNS Role
    - name: Install DNS Server role
      ansible.windows.win_feature:
        name: DNS
        include_management_tools: yes
        state: present

    # 2ï¸âƒ£ Ensure DNS service is running
    - name: Ensure DNS service is running
      ansible.windows.win_service:
        name: DNS
        start_mode: auto
        state: started

    # 3ï¸âƒ£ Create Forward Lookup Zone
    - name: Create Forward Lookup Zone if not exists
      ansible.windows.win_shell: |
        Import-Module DnsServer
        if (-not (Get-DnsServerZone -Name "{{ forward_zone }}" -ErrorAction SilentlyContinue)) {
            Add-DnsServerPrimaryZone -Name "{{ forward_zone }}" -ZoneFile "{{ forward_zone }}.dns" -DynamicUpdate None
            Write-Output "Forward zone '{{ forward_zone }}' created."
        } else {
            Write-Output "Forward zone '{{ forward_zone }}' already exists."
        }
      args:
        executable: powershell

    # 4ï¸âƒ£ Create Reverse Lookup Zone
    - name: Create Reverse Lookup Zone if not exists
      ansible.windows.win_shell: |
        Import-Module DnsServer
        $forward_network = "192.168.1"
        $reverse_zone_name = "{{ reverse_network }}.in-addr.arpa"
        if (-not (Get-DnsServerZone -Name $reverse_zone_name -ErrorAction SilentlyContinue)) {
            Add-DnsServerPrimaryZone -NetworkID "$($forward_network).0/24" -ZoneFile "$($reverse_zone_name).dns" -DynamicUpdate None
            Write-Output "Reverse zone $reverse_zone_name created."
        } else {
            Write-Output "Reverse zone $reverse_zone_name already exists."
        }
      args:
        executable: powershell


    # 5ï¸âƒ£ Configure DNS Forwarders
    - name: Configure DNS forwarders
      ansible.windows.win_shell: |
        Import-Module DnsServer
        Set-DnsServerForwarder -IPAddress {{ dns_forwarders | join(',') }}
        Write-Output "DNS forwarders set: {{ dns_forwarders | join(', ') }}"
      args:
        executable: powershell

    # 6ï¸âƒ£ Add A Record for DNS server
    - name: Add A record for local DNS server
      ansible.windows.win_shell: |
        Import-Module DnsServer
        if (-not (Get-DnsServerResourceRecord -ZoneName "{{ forward_zone }}" -Name "{{ dns_server_name }}" -RRType "A" -ErrorAction SilentlyContinue)) {
            Add-DnsServerResourceRecordA -Name "{{ dns_server_name }}" -ZoneName "{{ forward_zone }}" -IPv4Address "{{ dns_server_ip }}"
            Write-Output "A record {{ dns_server_name }}.{{ forward_zone }} -> {{ dns_server_ip }} created."
        } else {
            Write-Output "A record {{ dns_server_name }}.{{ forward_zone }} already exists."
        }
      args:
        executable: powershell

    # 7ï¸âƒ£ Add A Record for Web Server
    - name: Add A record for webserver
      ansible.windows.win_shell: |
        Import-Module DnsServer
        if (-not (Get-DnsServerResourceRecord -ZoneName "{{ forward_zone }}" -Name "{{ host_name }}" -RRType "A" -ErrorAction SilentlyContinue)) {
            Add-DnsServerResourceRecordA -Name "{{ host_name }}" -ZoneName "{{ forward_zone }}" -IPv4Address "{{ web_server_ip }}"
            Write-Output "A record {{ host_name }}.{{ forward_zone }} -> {{ web_server_ip }} created."
        } else {
            Write-Output "A record {{ host_name }}.{{ forward_zone }} already exists."
        }
      args:
        executable: powershell

    # 8ï¸âƒ£ Add PTR Record for Reverse Zone
    - name: Add PTR record for WebServer
      ansible.windows.win_shell: |
        Import-Module DnsServer
        $reverse_zone_name = "{{ reverse_network }}.in-addr.arpa"
        $last_octet = "{{ web_server_ip.split('.')[-1] }}"
        if (-not (Get-DnsServerResourceRecord -ZoneName $reverse_zone_name -Name $last_octet -RRType "PTR" -ErrorAction SilentlyContinue)) {
            Add-DnsServerResourceRecordPtr -Name $last_octet -ZoneName $reverse_zone_name -PtrDomainName "{{ host_name }}.{{ forward_zone }}."
            Write-Output "PTR record {{ web_server_ip }} -> {{ host_name }}.{{ forward_zone }} created."
        } else {
            Write-Output "PTR record {{ web_server_ip }} already exists."
        }
      args:
        executable: powershell

    - name: Add PTR record for DNS Server
      ansible.windows.win_shell: |
        Import-Module DnsServer
        $reverse_zone_name = "{{ reverse_network }}.in-addr.arpa"
        $last_octet = "{{ dns_server_ip.split('.')[-1] }}"
        if (-not (Get-DnsServerResourceRecord -ZoneName $reverse_zone_name -Name $last_octet -RRType "PTR" -ErrorAction SilentlyContinue)) {
            Add-DnsServerResourceRecordPtr -Name $last_octet -ZoneName $reverse_zone_name -PtrDomainName "{{ dns_server_name }}.{{ forward_zone }}."
            Write-Output "PTR record {{ dns_server_ip }} -> {{ dns_server_name }}.{{ forward_zone }} created."
        } else {
            Write-Output "PTR record {{ dns_server_ip }} already exists."
        }
      args:
        executable: powershell
