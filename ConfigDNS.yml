---
- name: Configure DNS using win_shell (With Forwarders)
  hosts: Server
  gather_facts: no
  vars:
    forward_zone: "local"
    host_name: "webserver"
    web_server_ip: "192.168.101.172"
    dns_forwarders:
      - "8.8.8.8"
      - "1.1.1.1"
      - "8.8.4.4"

  tasks:
    - name: Install and configure DNS in one task
      ansible.windows.win_shell: |
        # Install DNS if not installed
        if (-not (Get-WindowsFeature -Name DNS).Installed) {
            Install-WindowsFeature -Name DNS -IncludeManagementTools
        }
        
        # Import DNS module
        Import-Module DnsServer
        
        # Create forward zone if it doesn't exist
        if (-not (Get-DnsServerZone -Name "{{ forward_zone }}" -ErrorAction SilentlyContinue)) {
            Add-DnsServerPrimaryZone -Name "{{ forward_zone }}" -DynamicUpdate Secure
            Write-Output "Created forward zone: {{ forward_zone }}"
        } else {
            Write-Output "Forward zone '{{ forward_zone }}' already exists"
        }
        
        # Create reverse zone if it doesn't exist
        if (-not (Get-DnsServerZone -Name "101.168.192.in-addr.arpa" -ErrorAction SilentlyContinue)) {
            Add-DnsServerPrimaryZone -NetworkID "192.168.101.0/24" -DynamicUpdate Secure
            Write-Output "Created reverse zone: 101.168.192.in-addr.arpa"
        } else {
            Write-Output "Reverse zone '101.168.192.in-addr.arpa' already exists"
        }
        
        # Configure DNS forwarders
        Set-DnsServerForwarder -IPAddress {{ dns_forwarders | join(',') }}
        Write-Output "Configured DNS forwarders: {{ dns_forwarders | join(', ') }}"
        
        # Add A record
        try {
            Add-DnsServerResourceRecordA -Name "{{ host_name }}" -ZoneName "{{ forward_zone }}" -IPv4Address "{{ web_server_ip }}" -ErrorAction Stop
            Write-Output "Added A record: {{ host_name }}.{{ forward_zone }} -> {{ web_server_ip }}"
        } catch {
            Write-Output "A record already exists or error: $($_.Exception.Message)"
        }
        
        # Add PTR record
        try {
            Add-DnsServerResourceRecordPtr -Name "172" -ZoneName "101.168.192.in-addr.arpa" -PtrDomainName "{{ host_name }}.{{ forward_zone }}." -ErrorAction Stop
            Write-Output "Added PTR record: {{ web_server_ip }} -> {{ host_name }}.{{ forward_zone }}."
        } catch {
            Write-Output "PTR record already exists or error: $($_.Exception.Message)"
        }
        
        Write-Output "âœ… DNS configuration completed successfully"
      register: dns_setup

    - name: Show DNS setup result
      debug:
        var: dns_setup.stdout
