---
- name: Configure DNS Server with Correct Parameters
  hosts: Server
  gather_facts: no
  vars:
    forward_zone: "local"
    host_name: "webserver"
    web_server_ip: "192.168.101.172"
    reverse_zone_name: "101.168.192.in-addr.arpa"

  tasks:
    - name: Install DNS Server role
      ansible.windows.win_feature:
        name: DNS
        state: present
      register: dns_install

    - name: Reboot if DNS was installed
      ansible.windows.win_reboot:
        msg: "Rebooting after DNS installation"
      when: dns_install is changed

    - name: Wait for reboot completion
      ansible.builtin.wait_for_connection:
        delay: 30
        timeout: 600
      when: dns_install is changed

    - name: Create Reverse Lookup Zone
      ansible.windows.win_dns_zone:
        name: "{{ reverse_zone_name }}"
        state: present
        type: Primary
        dynamic_update: Secure

    - name: Create Forward Lookup Zone
      ansible.windows.win_dns_zone:
        name: "{{ forward_zone }}"
        state: present
        type: Primary
        dynamic_update: Secure

    - name: Add A Record
      ansible.windows.win_dns_record:
        zone: "{{ forward_zone }}"
        record: "{{ host_name }}"
        type: A
        value: "{{ web_server_ip }}"
        state: present

    - name: Add PTR Record
      ansible.windows.win_dns_record:
        zone: "{{ reverse_zone_name }}"
        record: "172"
        type: PTR
        value: "{{ host_name }}.{{ forward_zone }}."
        state: present

    - name: Test DNS configuration
      ansible.windows.win_shell: |
        nslookup {{ host_name }}.{{ forward_zone }}
        nslookup {{ web_server_ip }}
      register: dns_test

    - name: Show test results
      debug:
        var: dns_test.stdout_lines
