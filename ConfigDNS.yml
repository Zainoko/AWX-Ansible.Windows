---
- name: Configure DNS Server and Add A Record on Windows via SSH
  hosts: Server
  gather_facts: no
  vars:
    dns_zone: "Webserver.com"
    dns_record_name: "Webserver"
    dns_record_ip: "192.168.101.172"

  tasks:
    - name: Check if DNS Server feature is already installed
      ansible.windows.win_shell: |
        (Get-WindowsFeature -Name DNS).Installed
      register: dns_installed

    - name: Install DNS Server feature (with reboot handling)
      ansible.windows.win_feature:
        name: DNS
        include_management_tools: yes
        state: present
      register: dns_install
      when: not dns_installed.stdout | bool

    - name: Reboot if DNS was just installed
      ansible.windows.win_reboot:
        msg: "Rebooting after DNS Server installation"
        connect_timeout: 60
        pre_reboot_delay: 30
        post_reboot_delay: 60
      when: dns_install is changed

    - name: Wait for server to come back online after reboot
      ansible.builtin.wait_for_connection:
        connect_timeout: 60
        sleep: 10
        delay: 10
        timeout: 300
      when: dns_install is changed

    - name: Create Forward Lookup Zone if not exists
      ansible.windows.win_shell: |
        Import-Module DnsServer
        if (-not (Get-DnsServerZone -Name "{{ dns_zone }}" -ErrorAction SilentlyContinue)) {
            Add-DnsServerPrimaryZone -Name "{{ dns_zone }}" -ZoneFile "{{ dns_zone }}.dns" -DynamicUpdate Secure
        }

    - name: Add A Record for Webserver
      ansible.windows.win_shell: |
        Import-Module DnsServer
        if (-not (Get-DnsServerResourceRecord -ZoneName "{{ dns_zone }}" -Name "{{ dns_record_name }}" -RRType "A" -ErrorAction SilentlyContinue)) {
            Add-DnsServerResourceRecordA -Name "{{ dns_record_name }}" -ZoneName "{{ dns_zone }}" -IPv4Address "{{ dns_record_ip }}"
        }

    - name: Verify A Record
      ansible.windows.win_shell: |
        Import-Module DnsServer
        Get-DnsServerResourceRecord -ZoneName "{{ dns_zone }}" -Name "{{ dns_record_name }}"
      register: dns_result

    - name: Show DNS record
      ansible.builtin.debug:
        var: dns_result.stdout
